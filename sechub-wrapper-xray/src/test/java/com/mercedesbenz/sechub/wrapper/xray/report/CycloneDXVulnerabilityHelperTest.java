package com.mercedesbenz.sechub.wrapper.xray.report;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertThrows;

import java.util.ArrayList;
import java.util.List;

import org.cyclonedx.model.vulnerability.Vulnerability;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.mercedesbenz.sechub.wrapper.xray.XrayWrapperJSONConverter;

class CycloneDXVulnerabilityHelperTest {

    ObjectMapper mapper;
    CycloneDXVulnerabilityHelper vulnerability;

    @BeforeEach
    void beforeEach() {
        mapper = XrayWrapperJSONConverter.get().getMapper();
        vulnerability = new CycloneDXVulnerabilityHelper();
    }

    @Test
    void addCwe_valid_cwe() {
        /* prepare */
        ArrayNode cwe = mapper.createArrayNode();
        cwe.add("CWE-123");

        /* execute */
        vulnerability.addCWE(cwe);

        /* test */
        assertEquals(1, vulnerability.getVulnerability().getCwes().size());
    }

    @Test
    void addCWE_throws_nullPointerException() {
        assertThrows(NullPointerException.class, () -> vulnerability.addCWE(null));
    }

    @Test
    void addCwe_valid_cwe_contains_noInfo() {
        /* prepare */
        ArrayNode cwe = mapper.createArrayNode();
        cwe.add("CWE-noinfo");

        /* execute */
        vulnerability.addCWE(cwe);

        /* test */
        assertEquals(0, vulnerability.getVulnerability().getCwes().size());
    }

    @Test
    void addCwe_add_multiple_cwes() {
        /* prepare */
        ArrayNode cwe = mapper.createArrayNode();
        cwe.add("CWE-123");
        cwe.add("CWE-892");
        cwe.add("CWE-883");
        List<Integer> list = new ArrayList<>();
        list.add(123);
        list.add(892);
        list.add(883);

        /* execute */
        vulnerability.addCWE(cwe);

        /* test */
        assertEquals(list, vulnerability.getVulnerability().getCwes());
    }

    @Test
    void addAffects_add_multiple_versions() {
        /* prepare */
        ArrayNode vul_versions = mapper.createArrayNode();
        ArrayNode fixed_version = mapper.createArrayNode();
        String ref = "testref";
        vul_versions.add("8.0");
        vul_versions.add("11.0");
        fixed_version.add("17.02");
        fixed_version.add("12.02");

        /* execute */
        vulnerability.addAffects(ref, vul_versions, fixed_version);

        /* test */
        List<Vulnerability.Affect> affects = vulnerability.getVulnerability().getAffects();
        Vulnerability.Affect affect = affects.get(0);
        assertEquals(1, affects.size());
        assertEquals(4, affect.getVersions().size());
    }

    @Test
    void addAffects_throws_nullPointerException() {
        assertThrows(NullPointerException.class, () -> vulnerability.addAffects(null, null, null));
    }

    @Test
    void addAffects_add_multiple_ranges() {
        /* prepare */
        ArrayNode vul_versions = mapper.createArrayNode();
        ArrayNode fixed_version = mapper.createArrayNode();
        String ref = "testref";
        vul_versions.add("8.0");
        vul_versions.add("<17.02");
        fixed_version.add("17.02");
        fixed_version.add("<8.0.02");

        /* execute */
        vulnerability.addAffects(ref, vul_versions, fixed_version);

        /* test */
        List<Vulnerability.Affect> affects = vulnerability.getVulnerability().getAffects();
        Vulnerability.Affect affect = affects.get(0);
        assertEquals(1, affects.size());
        assertEquals(4, affect.getVersions().size());
        assertEquals("vers:testref/<17.02", affect.getVersions().get(1).getRange());
    }

    @Test
    void addRating_valid_rating() {
        /* prepare */
        Double score = 10.0;
        String severity = "high";
        String method = "CVSSv2";
        String vector = "vector";
        String source = "NVD";
        XrayWrapperReportParser.RatingRecord ratingRecord = new XrayWrapperReportParser.RatingRecord(score, severity, method, vector, source);

        /* execute */
        vulnerability.addRating(ratingRecord);
        Vulnerability.Rating rating = vulnerability.getVulnerability().getRatings().get(0);

        /* test */
        assertEquals("CVSSv2", rating.getMethod().getMethodName());
    }

    @Test
    void addBom_ref_valid_bomref() {
        /* prepare */
        String bomref = "bomref";

        /* execute */
        vulnerability.getVulnerability().setBomRef(bomref);
        String actualBomReference = vulnerability.getVulnerability().getBomRef();

        /* test */
        assertEquals(bomref, actualBomReference);
    }

    @Test
    void addSource_valid_source() {
        /* prepare */
        String name = "myname";
        String url = "myurl";

        /* execute */
        vulnerability.addSource(url, name);
        String actualUrl = vulnerability.getVulnerability().getSource().getUrl();

        /* test */
        assertEquals(url, actualUrl);
    }
}