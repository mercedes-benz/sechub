package com.mercedesbenz.sechub.xraywrapper.report;

import java.io.File;
import java.util.HashMap;
import java.util.List;
import java.util.Objects;

import org.cyclonedx.model.Bom;
import org.cyclonedx.model.vulnerability.Vulnerability;
import org.junit.Assert;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;

class XrayWrapperReportVulnerabilityMapperTest {

    @Test
    public void test_mapVulnerabilities() {
        /* prepare */
        File file = new File("src/test/resources/xray-report-examples/Docker_SBOM_Export_CycloneDX.json");
        HashMap<String, CycloneDXVulnerabilityBuilder> vulnerabilityHashMap = new HashMap<>();
        CycloneDXVulnerabilityBuilder vulnerability01 = new CycloneDXVulnerabilityBuilder();
        vulnerability01.getVulnerability().setId("CVE-2021-37750");
        vulnerability01.getVulnerability().setBomRef("testBomRef01");
        vulnerabilityHashMap.put("CVE-2021-37750", vulnerability01);
        CycloneDXVulnerabilityBuilder vulnerability02 = new CycloneDXVulnerabilityBuilder();
        vulnerability02.getVulnerability().setId("CVE-2019-17594");
        vulnerability02.getVulnerability().setBomRef("testBomRef02");
        vulnerabilityHashMap.put("CVE-2019-17594", vulnerability02);

        /* execute */
        Bom bom = XrayWrapperReportVulnerabilityMapper.mapVulnerabilities(file, vulnerabilityHashMap);

        /* test */
        List<Vulnerability> vulnerabilities = bom.getVulnerabilities();
        for (Vulnerability vulnerability : vulnerabilities) {
            if (Objects.equals(vulnerability.getId(), "CVE-2021-37750")) {
                Assertions.assertEquals("testBomRef01", vulnerability.getBomRef());
            }
            if (Objects.equals(vulnerability.getId(), "CVE-2019-17594")) {
                Assertions.assertEquals("testBomRef02", vulnerability.getBomRef());
            }
        }
    }

    @Test
    public void test_mapVulnerabilities_null() {
        Assert.assertThrows(IllegalArgumentException.class, () -> XrayWrapperReportVulnerabilityMapper.mapVulnerabilities(null, null));
    }
}