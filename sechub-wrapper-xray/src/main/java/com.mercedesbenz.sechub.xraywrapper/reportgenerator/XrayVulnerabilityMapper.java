package com.mercedesbenz.sechub.xraywrapper.reportgenerator;

import java.io.File;
import java.io.IOException;
import java.util.HashMap;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;

public class XrayVulnerabilityMapper {

    public static ObjectNode mapVulnerabilities(File cyclonreport, HashMap<String, XrayCycloneVulnerability> vulnerabilityHashMap) throws IOException {
        ObjectMapper mapper = new ObjectMapper();
        JsonNode rootNode = new ObjectMapper().readTree(cyclonreport);
        JsonNode vulCyclone = rootNode.get("vulnerabilities");
        ArrayNode arryNode = mapper.createArrayNode();

        if (vulCyclone.isArray()) {
            for (JsonNode node : vulCyclone) {
                String id = node.get("id").asText();
                XrayCycloneVulnerability vul = vulnerabilityHashMap.get(id);
                if (vul != null) {
                    JsonNode analysis = node.get("analysis");
                    if (analysis != null) {
                        vul.setAnalysis(analysis);
                    }
                    // rewrite the node
                    arryNode.add(vul.getVulnerability());
                }
            }
        }
        ObjectNode root = (ObjectNode) rootNode;
        root.set("vulnerabilities", arryNode);
        return root;
    }
}
