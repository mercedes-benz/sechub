package com.mercedesbenz.sechub.xraywrapper.report;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;

public class XrayCycloneVulnerabilityBuilder {

    private String id;

    private ObjectNode vulnerability;

    private ObjectMapper objectMapper;

    public XrayCycloneVulnerabilityBuilder(String id) {
        this.id = id;
        this.objectMapper = new ObjectMapper();
        this.vulnerability = objectMapper.createObjectNode();
    }

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
        this.vulnerability.put("id", id);
    }

    public ObjectNode getVulnerability() {
        return vulnerability;
    }

    public void addBom_ref(String bomref) {
        this.vulnerability.put("bom-ref", bomref);
    }

    public void addCWE(ArrayNode cwe) {
        ArrayNode arrayNode = objectMapper.createArrayNode();
        for (JsonNode node : cwe) {
            String s = node.asText();
            if (s.contains("noinfo"))
                continue;
            try {
                s = s.split("-")[1];
                arrayNode.add(Integer.parseInt(s));
            } catch (NumberFormatException e) {
                break;
            }
        }
        this.vulnerability.set("cwes", arrayNode);
    }

    public void addSource(String url_string, String name_string) {
        ObjectNode source = objectMapper.createObjectNode();
        source.put("url", url_string);
        source.put("name", name_string);
        this.vulnerability.set("source", source);
    }

    public void addRating(Float score, String severity, String method, String vector, String source_name) {
        ArrayNode arrayRating = objectMapper.createArrayNode();
        ObjectNode nestedNode = objectMapper.createObjectNode();
        ObjectNode source = objectMapper.createObjectNode();

        String url = "";
        if (!this.getId().contains("XRAY")) {
            url = "https://nvd.nist.gov/vuln/detail/" + this.getId();
        }
        source.put("name", source_name);
        source.put("url", url);
        nestedNode.set("source", source);
        nestedNode.put("score", score);
        nestedNode.put("severity", severity);
        nestedNode.put("method", method);
        nestedNode.put("vector", vector);

        arrayRating.add(nestedNode);
        this.vulnerability.set("ratings", arrayRating);
    }

    public void addDescription(String description) {
        this.vulnerability.put("description", description);
    }

    public void addAnalysis(JsonNode analysis) {
        this.vulnerability.set("analysis", analysis);
    }

    // example
    // https://github.com/CycloneDX/bom-examples/blob/7d529848e2f8bd65d03aec9eab16f139fd445ff4/VEX/Use-Cases/Case-10/vex.json#L48
    // https://github.com/CycloneDX/bom-examples/blob/7d529848e2f8bd65d03aec9eab16f139fd445ff4/VEX/CISA-Use-Cases/Case-7/vex.json#L29
    // https://github.com/CycloneDX/bom-examples/blob/7d529848e2f8bd65d03aec9eab16f139fd445ff4/VEX/Use-Cases/Case-5/vex.json#L35

    public void addAffects(String ref, ArrayNode vul_versions, ArrayNode fixed_versions, String purls) {
        ObjectNode component = objectMapper.createObjectNode();
        component.put("ref", ref);
        ArrayNode versions = objectMapper.createArrayNode();
        ArrayNode affects = objectMapper.createArrayNode();

        // todo: not correct format ( correct: vers:semver/<1.5.0|>=7.0.) but valid
        if (vul_versions != null)
            putVersions(vul_versions, versions, "affected", purls);
        if (fixed_versions != null)
            putVersions(fixed_versions, versions, "unaffected", purls);

        component.set("versions", versions);
        affects.add(component);
        this.vulnerability.set("affects", affects);
    }

    private void putVersions(ArrayNode arrayNode, ArrayNode versions, String status, String purls) {
        boolean isRange = false;
        StringBuilder cycloneVersion = new StringBuilder(purls);
        for (JsonNode node : arrayNode) {
            // only ≤ and < are used in Xray report
            String s = node.asText();
            // versions are a range
            if (s.contains("<") | s.contains("≤") | s.contains("All Versions") | s.contains(">") | s.contains("≥")) {
                isRange = true;
                s = s.replace(" ", "");
                cycloneVersion.append("@").append(s);
            } else {
                ObjectNode cycloneArrayNode = objectMapper.createObjectNode();
                cycloneArrayNode.put("version", s);
                cycloneArrayNode.put("status", status);
                versions.add(cycloneArrayNode);
            }
        }
        if (isRange) {
            ObjectNode cycloneArrayNode = objectMapper.createObjectNode();
            cycloneArrayNode.put("range", cycloneVersion.toString());
            cycloneArrayNode.put("status", status);
            versions.add(cycloneArrayNode);
        }
    }
}
