package com.mercedesbenz.sechub.wrapper.xray.report;

import java.io.File;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import org.cyclonedx.exception.ParseException;
import org.cyclonedx.model.Bom;
import org.cyclonedx.model.vulnerability.Vulnerability;
import org.cyclonedx.parsers.JsonParser;

public class XrayWrapperReportVulnerabilityMapper {

    public static Bom mapVulnerabilities(File cycloneDXreport, HashMap<String, CycloneDXVulnerabilityHelper> vulnerabilityHashMap)
            throws XrayWrapperReportException {
        JsonParser jsonParser = new JsonParser();
        Bom cycloneDXBom;
        List<Vulnerability> mappedCycloneVulnerabilities = new ArrayList<>();
        try {
            cycloneDXBom = jsonParser.parse(cycloneDXreport);
        } catch (ParseException e) {
            throw new XrayWrapperReportException("Cannot read CycloneDX report");
        }
        List<Vulnerability> cycloneVulnerabilities = cycloneDXBom.getVulnerabilities();

        if (!cycloneVulnerabilities.isEmpty()) {
            for (Vulnerability cycloneVulnerability : cycloneVulnerabilities) {
                String id = cycloneVulnerability.getId();
                CycloneDXVulnerabilityHelper vulnerability = vulnerabilityHashMap.get(id);
                if (vulnerability != null) {
                    Vulnerability.Analysis analysis = cycloneVulnerability.getAnalysis();
                    if (analysis != null) {
                        vulnerability.getVulnerability().setAnalysis(analysis);
                    }
                    mappedCycloneVulnerabilities.add(vulnerability.getVulnerability());
                }
            }
        }
        cycloneDXBom.setVulnerabilities(mappedCycloneVulnerabilities);
        return cycloneDXBom;
    }
}
