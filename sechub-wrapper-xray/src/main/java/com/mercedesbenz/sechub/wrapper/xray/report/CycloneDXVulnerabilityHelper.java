package com.mercedesbenz.sechub.wrapper.xray.report;

import java.util.ArrayList;
import java.util.List;

import org.cyclonedx.model.vulnerability.Vulnerability;
import org.cyclonedx.model.vulnerability.Vulnerability.Source;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.node.ArrayNode;

/**
 * Builds a cycloneDX vulnerability according to CycloneDX standard 1.4 @see <a
 * href="https://cyclonedx.org/docs/1.4/json/"/a> examples: <a
 * href="https://github.com/CycloneDX/bom-examples/blob/7d529848e2f8bd65d03aec9eab16f139fd445ff4/VEX/Use-Cases/Case-10/vex.json#L48"/a>
 * <a
 * href="https://github.com/CycloneDX/bom-examples/blob/7d529848e2f8bd65d03aec9eab16f139fd445ff4/VEX/CISA-Use-Cases/Case-7/vex.json#L29"/a>
 * <a
 * href="https://github.com/CycloneDX/bom-examples/blob/7d529848e2f8bd65d03aec9eab16f139fd445ff4/VEX/Use-Cases/Case-5/vex.json#L35"/a>
 */
public class CycloneDXVulnerabilityHelper {

    Vulnerability vulnerability;

    public CycloneDXVulnerabilityHelper() {
        this.vulnerability = new Vulnerability();
        this.vulnerability.setId("default");
    }

    public Vulnerability getVulnerability() {
        return vulnerability;
    }

    public void addCWE(ArrayNode cweArray) {
        List<Integer> cwes = new ArrayList<>();
        for (JsonNode node : cweArray) {
            String cweInfo = node.asText();
            if (cweInfo.contains("noinfo")) {
                // no information about cwe available
                continue;
            }
            try {
                cweInfo = cweInfo.split("-")[1];
                cwes.add(Integer.parseInt(cweInfo));
            } catch (NumberFormatException e) {
                // if anything else is in the cwe info that does not contain cwe number we don't
                // want to add it
                // cycloneDX only allows integer, but cwes are optional
                break;
            }
        }
        this.vulnerability.setCwes(cwes);
    }

    public void addSource(String sourceUrl, String sourceName) {
        Source source = new Source();
        source.setName(sourceName);
        source.setUrl(sourceUrl);
        this.vulnerability.setSource(source);
    }

    /**
     * Adds rating to the vulnerability
     *
     * @param ratingRecord contains necessary rating information
     */
    public void addRating(XrayWrapperReportParser.RatingRecord ratingRecord) {
        Vulnerability.Rating rating = new Vulnerability.Rating();

        String sourceUrl = "";
        String id = this.vulnerability.getId();
        if (!id.contains("XRAY")) {
            sourceUrl = "https://nvd.nist.gov/vuln/detail/" + id;
        }

        Source source = new Source();
        source.setName(ratingRecord.severitySource());
        source.setUrl(sourceUrl);
        rating.setSource(source);

        rating.setScore(ratingRecord.scoreDouble());

        rating.setSeverity(Vulnerability.Rating.Severity.fromString(ratingRecord.severity()));

        rating.setMethod(Vulnerability.Rating.Method.fromString(ratingRecord.method()));

        rating.setVector(ratingRecord.vector());

        this.vulnerability.addRating(rating);

    }

    /**
     * Affects are the components or services that are affected by the
     * vulnerability.
     *
     * @param reference          component refercene
     * @param vulnerableVersions
     * @param fixedVersions
     */
    public void addAffects(String reference, ArrayNode vulnerableVersions, ArrayNode fixedVersions) {
        Vulnerability.Affect affect = new Vulnerability.Affect();
        List<Vulnerability.Affect> affects = new ArrayList<>();
        List<Vulnerability.Version> versions = new ArrayList<>();
        affect.setRef(reference);
        String packageName = reference.split(":")[0];
        transformVersions(vulnerableVersions, "affected", packageName, versions);
        transformVersions(fixedVersions, "unaffected", packageName, versions);
        affect.setVersions(versions);
        affects.add(affect);
        this.vulnerability.setAffects(affects);

    }

    private void transformVersions(ArrayNode securityVersions, String status, String packageName, List<Vulnerability.Version> versions) {
        // "All Versions", "< 1.19.10", "1.20.0-0 ≤ Version < 1.20.5", "1.2.34"
        // cycloneDX using Version Range Spec (vers) vers:npm/1.2.3|>=2.0.0|<5.0.0
        packageName = "vers:" + packageName + "/";
        if (securityVersions != null) {
            for (JsonNode entry : securityVersions) {
                String versionString = entry.asText();
                Vulnerability.Version version = new Vulnerability.Version();
                if (versionString.equals("All Versions")) {
                    version.setRange(packageName + ">=0.0.0");

                } else if (versionString.contains("Version")) {
                    versionString = versionString.replace(" ", "");
                    String[] split = versionString.split("Version");
                    version.setRange(packageName + split[0] + "|" + split[1]);

                } else if (versionString.contains("<") | versionString.contains("≤")) {
                    versionString = versionString.replace(" ", "");
                    version.setRange(packageName + versionString);

                } else {
                    version.setVersion(versionString);
                }
                version.setStatus(Vulnerability.Version.Status.fromString(status));
                versions.add(version);
            }
        }
    }
}
