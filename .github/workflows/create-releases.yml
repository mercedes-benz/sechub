# SPDX-License-Identifier: MIT
name: Release

on:
  workflow_dispatch:
    inputs:
      server-version:
        description: Server Version (e.g. 0.27.0)
        required: false
      server-milestone-number:
        description: Server Milestone number (e.g. 45)
        required: false
      client-version:
        description: Client Version (e.g. 0.23.0)
        required: false
      client-milestone-number:
        description: Client Milestone number (e.g. 47)
        required: false
      pds-version:
        description: PDS Version (e.g. 0.20.0)
        required: false
      pds-milestone-number:
        description: PDS Milestone number (e.g. 46)
        required: false
jobs:
  release-version:
    name: Create releases
    runs-on: ubuntu-latest
    steps:
      - name: "Show Inputs"
        run: |
          echo "Server \'${{ inputs.server-version }}\' - Milestone \'${{ inputs.server-milestone-number }}\'"
          echo "Client \'${{ inputs.client-version }}\' - Milestone \'${{ inputs.client-milestone-number }}\'"
          echo "PDS \'${{ inputs.pds-version }}\' - Milestone \'${{ inputs.pds-milestone-number }}\'"
      # Check inputs if a milestone number is provided for each version to be released:
      - name: "Verify Input: Server"
        if: (inputs.server-version != '') && (inputs.server-milestone-number == '')
        run: |
          echo "For Server release, server-milestone-number must be provided!"
          exit 1
      - name: "Verify Input: Client"
        if: (inputs.client-version != '') && (inputs.client-milestone-number == '')
        run: |
          echo "For Client release, client-milestone-number must be provided!"
          exit 1
      - name: "Verify Input: PDS"
        if: (inputs.pds-version != '') && (inputs.pds-milestone-number == '')
        run: |
          echo "For PDS release, pds-milestone-number must be provided!"
          exit 1

      - name: Checkout master
        uses: actions/checkout@v2
        with:
          ref: master
      # Create temporary local tags, so we build documentation for this tag...
      # The final tag on git server side will be done by the release when the draft is saved as "real" release
      # automatically.
      - name: "Temporary tag server version: v${{ inputs.server-version }}-server - if defined"
        if: inputs.server-version != ''
        run: git tag v${{ inputs.server-version }}-server

      - name: "Temporary tag client version: v${{ inputs.client-version }}-client - if defined"
        if: inputs.client-version != ''
        run: git tag v${{ inputs.client-version }}-client

      - name: "Temporary tag PDS version: v${{ inputs.pds-version }}-pds - if defined"
        if: inputs.pds-version != ''
        run: git tag v${{ inputs.pds-version }}-pds

      # ----------------------
      # Setup + Caching
      # ----------------------
      - name: Set up JDK 1.8
        uses: actions/setup-java@v2
        with:
          java-version: 8
          distribution: adopt
          cache: gradle
      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.17
          stable: true
      - uses: actions/cache@v2
        id: go-cache
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Gradle clean
        run: ./gradlew clean

      # ----------------------
      # SecHub Client
      # ----------------------
      - name: Build Client
        run: ./gradlew :sechub-cli:buildGo :sechub-cli:testGo

      # ----------------------
      # SecHub Server
      # ----------------------
      - name: Build Server
        run: ./gradlew ensureLocalhostCertificate build generateOpenapi buildDeveloperAdminUI -x :sechub-integrationtest:test -x :sechub-cli:build

      # ----------------------
      # API Java publish
      # ----------------------
      - name: Generate, build (and publish on server release) Java API
        run: ./gradlew :sechub-api-java:buildAPIJava
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
      
      # ----------------------
      # Integration test (force positive result)
      # ----------------------
      - name: Integration test
        run: ./gradlew integrationtest || true

      - name: Create combined test report
        run: ./gradlew createCombinedTestReport

      # To identifiy parts not in git history and leading to "-dirty-$commitId" markern in documentation
      - name: Inspect GIT status
        run: git status > build/reports/git-status.txt

      # -----------------------------------------
      # Upload Build Artifacts
      # -----------------------------------------
      - name: Archive combined test report
        uses: actions/upload-artifact@v2
        with:
          name: combined-sechub-testreport
          path: build/reports/combined-report
          retention-days: 14
      - name: Archive GIT status
        uses: actions/upload-artifact@v2
        with:
          name: git-status.txt
          path: build/reports/git-status.txt
          retention-days: 14
      - name: Archive sechub server artifacts
        uses: actions/upload-artifact@v2
        with:
          name: sechub-server
          path: sechub-server/build/libs
          retention-days: 14

      - name: Archive pds server artifacts
        uses: actions/upload-artifact@v2
        with:
          name: sechub-server
          path: sechub-server/build/libs

      - name: Archive developer tools artifacts
        uses: actions/upload-artifact@v2
        with:
          name: sechub-developertools
          path: sechub-developertools/build/libs
          retention-days: 14

      - name: Archive sechub client artifacts
        uses: actions/upload-artifact@v2
        with:
          name: sechub-client
          path: sechub-cli/build/go
          retention-days: 14

      - name: Install graphviz (asciidoc diagrams)
        run: sudo apt-get install graphviz

      # -----------------------------------------
      # Build Documentation
      # -----------------------------------------
      - name: Create documentation
        run: ./gradlew documentation-with-pages

      # -----------------------------------------
      # Upload documentation
      # -----------------------------------------
      - name: Archive documentation HTML
        uses: actions/upload-artifact@v2
        with:
          name: sechub-docs-html
          path: sechub-doc/build/docs/final-html/
          retention-days: 14

      - name: Archive documentation PDF
        uses: actions/upload-artifact@v2
        with:
          name: sechub-docs-pdf
          path: sechub-doc/build/docs/asciidoc/*.pdf
          retention-days: 14

      - name: Archive documentation openAPI3
        uses: actions/upload-artifact@v2
        with:
          name: sechub-api-spec
          path: sechub-doc/build/api-spec/
          retention-days: 14

      # -----------------------------------------
      # Update and commit release documentation for https://mercedes-benz.github.io/sechub/
      # -----------------------------------------
      - name: Update release documentation
        id: update_release_documentation
        run: |
          git reset --hard
          git config user.name "SecHub release job (github-actions)"
          git config user.email github-actions-sechub@users.noreply.github.com
          sechub-doc/helperscripts/publish+git-add-releasedocs.sh
          git commit -m "docs update by SecHub release job @github-actions"

      # -----------------------------------------
      # Create pull request for release documentation
      # -----------------------------------------
      - name: Create pull request for release documentation
        id: pr_release_documentation
        uses: peter-evans/create-pull-request@v3
        with:
          branch: documentation-release
          branch-suffix: timestamp
          delete-branch: true
          title: '1 - Documentation release [auto-generated]'
          body: |
            Release of SecHub documentation
            - Server "${{ inputs.server-version }}"
            - Client "${{ inputs.client-version }}"
            - PDS "${{ inputs.pds-version }}"

            Auto-generated by Github Actions release job.
            Please review and merge along with the release.

      - name: Print PR infos
        run: |
          echo "Pull Request Number - ${{ steps.pr_release_documentation.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.pr_release_documentation.outputs.pull-request-url }}"

      # -----------------------------------------
      # Assert releaseable, so no dirty flags on releases
      # even when all artifact creation parts are done!
      # -----------------------------------------
      - name: Assert releasable
        run: ./gradlew assertReleaseable
      # ******************************************
      # Now let's create a new SERVER release
      # when server version is set
      # ******************************************
      - name: Create server release
        id: create_server_release
        if: inputs.server-version != ''
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
        with:
          tag_name: v${{ inputs.server-version }}-server
          commitish: master
          release_name: Server Version ${{ inputs.server-version }}
          body: |
            Changes in this Release
            - Some minor changes on SecHub server implementation

            For more details please look at [Milestone ${{inputs.server-milestone-number}}]( https://github.com/mercedes-benz/sechub/milestone/${{inputs.server-milestone-number}}?closed=1)
          draft: true
          prerelease: false
      - name: Upload Server release asset
        id: upload-server-release-asset
        if: inputs.server-version != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_server_release.outputs.upload_url }}
          asset_path: ./sechub-server/build/libs/sechub-server-${{ inputs.server-version }}.jar
          asset_name: sechub-server-${{ inputs.server-version }}.jar
          asset_content_type: application/zip
      - name: Upload SecHub developer tools release asset
        id: upload-developertools-release-asset
        if: inputs.server-version != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_server_release.outputs.upload_url }}
          asset_path: ./sechub-developertools/build/libs/sechub-developertools-${{ inputs.server-version }}.jar
          asset_name: sechub-developertools-${{ inputs.server-version }}.jar
          asset_content_type: application/zip
      # -----------------------------------------
      # Server documentation:
      # -----------------------------------------
      # sechub-architecture.pdf
      - name: Upload sechub-architecture.pdf release asset
        id: upload-sechub-doc-architecture-release-asset
        if: inputs.server-version != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_server_release.outputs.upload_url }}
          asset_path: ./sechub-doc/build/docs/asciidoc/sechub-architecture.pdf
          asset_name: sechub-architecture-${{ inputs.server-version }}.pdf
          asset_content_type: application/pdf
      # sechub-operations.pdf
      - name: Upload sechub-operations.pdf release asset
        id: upload-sechub-doc-operations-release-asset
        if: inputs.server-version != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_server_release.outputs.upload_url }}
          asset_path: ./sechub-doc/build/docs/asciidoc/sechub-operations.pdf
          asset_name: sechub-operations-${{ inputs.server-version }}.pdf
          asset_content_type: application/pdf
      # sechub-quickstart-guide.pdf
      - name: Upload sechub-quickstart-guide.pdf release asset
        id: upload-sechub-doc-quickstart-guide-release-asset
        if: inputs.server-version != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_server_release.outputs.upload_url }}
          asset_path: ./sechub-doc/build/docs/asciidoc/sechub-quickstart-guide.pdf
          asset_name: sechub-quickstart-guide-${{ inputs.server-version }}.pdf
          asset_content_type: application/pdf

      # sechub-restapi.pdf
      - name: Upload sechub-restapi.pdf release asset
        id: upload-sechub-doc-restapi-release-asset
        if: inputs.server-version != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_server_release.outputs.upload_url }}
          asset_path: ./sechub-doc/build/docs/asciidoc/sechub-restapi.pdf
          asset_name: sechub-restapi-${{ inputs.server-version }}.pdf
          asset_content_type: application/pdf

      - name: Upload sechub-openapi3.json release asset
        id: upload-sechub-doc-openapi3-release-asset
        if: inputs.server-version != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_server_release.outputs.upload_url }}
          asset_path: ./sechub-doc/build/api-spec/openapi3.json
          asset_name: sechub-openapi3-${{ inputs.server-version }}.json
          asset_content_type: text/plain
 

      # ******************************************
      # Now let's create a new CLIENT release
      # when client version is set
      # ******************************************
      - name: Create client release
        id: create_client_release
        if: inputs.client-version != ''
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
        with:
          tag_name: v${{ inputs.client-version }}-client
          commitish: master
          release_name: Client Version ${{ inputs.client-version }}
          body: |
            Changes in this Release
            - Some minor changes on client implementation

            For more details please look at [Milestone ${{inputs.client-milestone-number}}]( https://github.com/mercedes-benz/sechub/milestone/${{inputs.client-milestone-number}}?closed=1)
          draft: true
          prerelease: false
      - name: Upload Client release asset create ZIP
        id: create-client-release-asset
        if: inputs.client-version != ''
        run: |
          cd sechub-cli/build/go
          zip -r sechub-cli.zip platform
          sha256sum sechub-cli.zip > sechub-cli.zip.sha256
          cd ../../../
      - name: Upload Client release asset
        id: upload-client-release-asset
        if: inputs.client-version != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_client_release.outputs.upload_url }}
          asset_path: ./sechub-cli/build/go/sechub-cli.zip
          asset_name: sechub-cli-${{ inputs.client-version }}.zip
          asset_content_type: application/zip
      - name: Upload Client release asset (SHA256)
        id: upload-client-release-asset-sha256
        if: inputs.client-version != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_client_release.outputs.upload_url }}
          asset_path: ./sechub-cli/build/go/sechub-cli.zip.sha256
          asset_name: sechub-cli-${{ inputs.client-version }}.zip.sha256
          asset_content_type: application/zip
      # sechub-client.pdf
      - name: Upload sechub-client.pdf release asset
        id: upload-sechub-doc-client-release-asset
        if: inputs.client-version != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_client_release.outputs.upload_url }}
          asset_path: ./sechub-doc/build/docs/asciidoc/sechub-client.pdf
          asset_name: sechub-client-${{ inputs.client-version }}.pdf
          asset_content_type: application/pdf

      # ******************************************
      # Now let's create a new PDS release
      # when pds version is set
      # ******************************************
      - name: Create PDS release
        id: create_pds_release
        if: inputs.pds-version != ''
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
        with:
          tag_name: v${{ inputs.pds-version }}-pds
          commitish: master
          release_name: PDS Version ${{ inputs.pds-version }}
          body: |
            Changes in this Release
            - Some minor changes on PDS server implementation

            For more details please look at [Milestone ${{inputs.pds-milestone-number}}]( https://github.com/mercedes-benz/sechub/milestone/${{inputs.pds-milestone-number}}?closed=1)
          draft: true
          prerelease: false
      - name: Upload PDS release asset
        id: upload-pds-release-asset
        if: inputs.pds-version != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_pds_release.outputs.upload_url }}
          asset_path: ./sechub-pds/build/libs/sechub-pds-${{ inputs.pds-version }}.jar
          asset_name: sechub-pds-${{ inputs.pds-version }}.jar
          asset_content_type: application/zip
      # sechub-product-delegation-server.pdf
      - name: Upload sechub-product-delegation-server.pdf release asset
        id: upload-sechub-doc-pds-release-asset
        if: inputs.pds-version != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_pds_release.outputs.upload_url }}
          asset_path: ./sechub-doc/build/docs/asciidoc/sechub-product-delegation-server.pdf
          asset_name: /sechub-product-delegation-server-${{ inputs.pds-version }}.pdf
          asset_content_type: application/pdf

      # Create a PR for merging back `master` -> `develop`
      # -----------------------------------------
      # Create pull request for merging back `master` into `develop`
      # -----------------------------------------
      - name: Create pull request for merging back master into develop
        id: pr_master_to_develop
        uses: peter-evans/create-pull-request@v3
        with:
          branch: documentation-release
          branch-suffix: timestamp
          delete-branch: true
          title: '2 - After release: Merge back into develop [auto-generated]'
          body: |
            After SecHub release
            - Client "${{ inputs.client-version }}"
            - Server "${{ inputs.server-version }}"
            - PDS "${{ inputs.pds-version }}"

            Merge `master` back into `develop`

            Auto-generated by Github Actions release job.
            Please review and merge **after the release**.

      - name: Print PR infos
        run: |
          echo "Pull Request Number - ${{ steps.pr_master_to_develop.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.pr_master_to_develop.outputs.pull-request-url }}"
