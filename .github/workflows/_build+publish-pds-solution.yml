# SPDX-License-Identifier: MIT
name: Build and publish one single PDS solution

on:
  workflow_dispatch:
    inputs:
      pds-solution:
        description: pds solution to build (e.g. gosec ; see sechub-pds-solutions/)
        required: true
      pds-version:
        description: pds-base version to use (e.g. 1.0.0)
        required: true
  workflow_call:
    inputs:
      pds-solution:
        required: true
        type: string
      pds-version:
        required: true
        type: string

env:
  ACTIONS_SECHUB_REGISTRY: ghcr.io/mercedes-benz/sechub
  ACTIONS_BASE_IMAGE: ghcr.io/mercedes-benz/sechub/pds-base:latest

jobs:
  build-pds-solution:
    name: Build and publish PDS solution
    runs-on: ubuntu-latest
    steps:
      - name: "Show Inputs"
        run: |
          echo "pds-solution '${{ inputs.pds-solution }}'"
          echo "pds-version '${{ inputs.pds-version }}'"

      - name: Checkout git repository
        uses: actions/checkout@v3

      # Build pds-base container image + push to ghcr
      - name: Build pds-base ${{ inputs.server-version }} container image + push to ghcr
        run: |
          PDS_SOLUTION="${{ inputs.pds-solution }}"
          PDS_VERSION="${{ inputs.pds-version }}"
          if [ ! -d "sechub-pds-solutions/$PDS_SOLUTION" ] ; then
            echo "Fatal: No directory named \"$PDS_SOLUTION\" found in sechub-pds-solutions/"
            exit 1
          fi
          cd "sechub-pds-solutions/$PDS_SOLUTION"
          DOCKER_REGISTRY="$ACTIONS_SECHUB_REGISTRY/pds-$PDS_SOLUTION"
          VERSION_TAG="${PDS_VERSION}"
          BASE_IMAGE="$ACTIONS_BASE_IMAGE"
          echo "# Building image $DOCKER_REGISTRY:$VERSION_TAG from $BASE_IMAGE"
          ./10-create-image.sh "$DOCKER_REGISTRY" "$VERSION_TAG" "$BASE_IMAGE"
          ./20-push-image.sh "$DOCKER_REGISTRY" "$VERSION_TAG" yes
